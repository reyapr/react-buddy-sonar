- pipeline: 'Build and test on every PR'
  trigger_mode: 'ON_EVERY_PUSH'
  ref_name: 'refs/heads/*'
  ref_type: 'WILDCARD'
  trigger_condition: 'ALWAYS'
  auto_clear_cache: true
  actions:
    - action: 'Execute: npm run lint, npm test, npm run build'
      type: 'BUILD'
      working_directory: '/buddy/sonar'
      docker_image_name: 'library/node'
      docker_image_tag: '12.18.3'
      execute_commands:
        - 'export CONNECTOR_API_KEY=apikey'
        - 'export NODE_ENV=test'
        - 'export LAUNCH_DARKLY_SDK_KEY='
        - 'export TEAM_NAME=test'
        - 'cp .npmrc.example .npmrc'
        - 'echo -ne "\n//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> .npmrc'
        - 'npm install'
        - 'npm run lint'
        - 'npm run format:check'
        - 'npm test'
        - 'npm run build'
        - 'rm -f .npmrc'
      volume_mappings:
        - '/:/buddy/sonar'
      trigger_condition: 'ALWAYS'
      shell: 'BASH'
    - action: 'Build Docker image'
      type: 'DOCKERFILE'
      region: 'ap-southeast-1'
      dockerfile_path: 'Dockerfile'
      build_args:
        - 'NPM_TOKEN=$NPM_TOKEN'
      trigger_condition: 'ALWAYS'
      integration_hash: '5e85761fc5f225000f97dd99'
